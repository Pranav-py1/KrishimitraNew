rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuth() {
      return request.auth != null;
    }

    function getRole() {
      // Note: This requires real Firebase Auth and a user document in the 'users' collection
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isExpert() {
      return isAuth() && getRole() == "expert";
    }

    function isFarmer() {
      return isAuth() && getRole() == "farmer";
    }

    function isAdmin() {
      return isAuth() && getRole() == "admin";
    }

    function isRetailer() {
      return isAuth() && (getRole() == "retailer" || getRole() == "supplier");
    }

    // --- Collection Rules ---

    // User profiles
    match /users/{userId} {
      allow read: if isAuth();
      allow write: if (isAuth() && request.auth.uid == userId) || isAdmin();
    }

    // Expert Articles (Guidance)
    match /expertArticles/{docId} {
      allow list: if true;   // Fixes listing error for all users
      allow get: if true;
      allow create: if isExpert();
      allow update, delete: if isExpert() && (resource == null || resource.data.expertId == request.auth.uid);
    }

    // Expert Posts (Generic posts)
    match /expertPosts/{docId} {
      allow list: if true;
      allow get: if true;
      allow create: if isExpert();
      allow update, delete: if isExpert() && (resource == null || resource.data.expertId == request.auth.uid);
    }

    // Consultations (Mapping of expertBookings from your request)
    match /consultations/{docId} {
      allow create: if isFarmer();
      allow list, get: if isAdmin() ||
        (isAuth() && resource.data.expertId == request.auth.uid) ||
        (isAuth() && resource.data.farmerId == request.auth.uid);
      allow update: if isAdmin() ||
        (isAuth() && resource.data.expertId == request.auth.uid);
    }

    // Machinery and Products
    match /machines/{id} {
      allow read: if true;
      allow write: if isAdmin() || isRetailer();
    }
    
    match /products/{id} {
      allow read: if true;
      allow write: if isAdmin() || isRetailer();
    }

    // Farmer Produce and Livestock
    match /produce/{id} {
      allow read: if true;
      allow write: if isFarmer() || isAdmin();
    }

    match /livestockListings/{id} {
      allow read: if true;
      allow write: if isFarmer() || isAdmin();
    }

    // Market Sales and Machine Bookings
    match /sales/{id} {
      allow read: if isAuth() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid || isAdmin());
      allow create: if isAuth();
    }

    match /bookings/{id} {
      allow read: if isAuth() && (resource.data.farmerId == request.auth.uid || resource.data.retailerId == request.auth.uid || isAdmin());
      allow create: if isFarmer();
      allow update: if isAuth();
    }

    // Soil Testing Services
    match /soilTests/{id} {
      allow create: if isFarmer();
      allow read: if isAdmin() || (isAuth() && resource.data.farmerId == request.auth.uid);
    }

    // --- Catch-all ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}